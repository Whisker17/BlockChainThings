# DAG

我们都知道，区块链的扩展性是一个急需解决的问题，我们需要对区块链进行一个扩容，否则当区块链上的交易增加到一定程度时，性能将会变得很低。那么如果我们单纯的增加区块大小，例如比特币，原本是10分钟1MB，我们增加到100MB，这样是否能够做到我们想要的扩容效果呢。可能大家会认为现在我们可以达到的效率是每分钟100MB，但是，由于网速的限制会导致很多节点还没有收到或者同步完新区块下一个区块就已经被挖出来了，这样就会导致全网的不一致，大家就会在不同的链上进行挖矿，这也就意味着在一条链上的算力就会大大减少。

因此就引出了一个DAG的结构来取代传统区块链的单链模式。

## 概念

DAG，即有向无环图，**在DAG中，没有区块的概念**，组成单元是一笔笔交易，每个单元记录的是单个用户的交易，这样就省去了打包出块的时间，同时它采用的是拓扑排序的方式，队列只能从时序先的到时序后的。

**验证手段则依赖于后一笔交易对前一笔交易的验证**。

这种验证手段，使得DAG可以**异步并发**的写入很多交易，并最终构成一种拓扑的树状结构，能够极大地提高扩展性。DAG基于深度工作，这就意味着每个节点都可能会包含多个交易层。**相比于链式结构，我们可以看到DAG的区别就在于异步和同步通讯。**

在DAG的网络中，每个节点都可以是交易者或者是验证者，一笔交易在被验证之前会先对另外两笔交易所在的节点进行验证。节点必须要检查这两笔交易是否存在冲突，与此同时，这样的验证方式也就是意味着验证交易只需要两次验证，而不是想POW那样全节点的方式，这样就可以大大减少不必要的资源损耗。

## DAG和区块链的比较

**DAG的优点：**

1. 随着交易量和用户的增加，处理速度会越来越快。我们知道传统区块链允许人们查询在账单中的任意时间的任意记录，这样的顺序结构也就是阻碍区块链交易吞吐量的重要原因。
2. 由于无交易费，可以提升交易量，增强去中心化。DAG的验证方式，使得所谓的矿工可以不需要存在，节点本身作为“矿工”
3. 可以通过基于DAG的多重交易确认机制来增加交易的可靠性以及降低出现双花交易的几率。
4. 采取的是最重链共识而不是最长链共识，这样就可以避免因为分叉而导致的小于51%的算力攻击。这里怎么理解呢，首先我们可以确定，如果在区块链上一个节点的子节点发生分叉，在此时会存在两条最长链，那么此时我们只需要有34%的算力就可以做到攻击成功，而同样的情况，在DAG中，由于我们是最重链共识，而在DAG中我们是基于深度的，所以在同一层中所有区块都是有效的，那么即使你拥有34%的算力，你也无法比在同一层的区块算力和更高，这样我们就依然需要达到51%的算力才能完成攻击。

**DAG的缺陷：**

1. **交易时长不可控**。DAG的验证规则是后面的交易验证前面的交易，这就很容易出现最后的交易迟迟无法被验证的情况，尤其是在整个网络发展的初期节点数量比较少的情况下，造成交易时长无法预测。
2. **不支持强一致性**。DAG作为一种谣言传播算法，其异步通讯机制在提高了扩展性的同时也带来了一致性的不可控问题。区块链是同步操作的验证机制，能够保证较高的一致性。但是DAG作为异步操作，**它不存在一个全局的排序机制，**在运行智能合约时，这就很可能会出现节点间所存储的数据在运行一段时间以后出现偏差的情况。
3. **安全性还没有得到大规模的验证**。
4. **区块信息重复导致冗余**。由于在DAG中同一层的区块都是有效的，而这些区块内的大量交易是重复的，就导致了资源的浪费。
5. 在对历史交易验证时采用随机方式，而没有任何先后规则，那么有可能产生某些交易在极端情况下没有任何其他节点对其验证，从而永远不会被确认。

## 区块链的孤块率问题

**孤块，指的就是由于不可避免的网络延迟而导致的在最长链之外创建的区块。**

我们在解决区块链的扩展性的时候，提高吞吐量很直观的方法就是提高出块率或者增加区块大小，但是单纯这样做会增加孤块率。在一个新区块广播到全网之前，很可能会有其他新的不引用它的区块被创建出来，同时孤块率的增加也会导致安全性的降低。

## DAG中的共识

对于一个分布式系统，如果我们能够做到对系统中的事务的顺序达成共识，那么我们就可以认为整个系统的共识也就达成了，因为我们只需要按照共识的顺序进行遍历，系统的结果就是一定的，这样我们也就能够维护系统的一致性了。

因此，我们只需要对于DAG中的所有区块，定义一个排序算法，让所有节点都会遵从这个算法而在区块顺序上达成最终顺序的共识。

而上文我们说过，DAG本身要求了以拓扑顺序进行入块，所以我们只需要对于并行创建的区块，即相互之间没有路径相连的区块所组成的集定义一种排序算法就可以达成全排序的愿望。