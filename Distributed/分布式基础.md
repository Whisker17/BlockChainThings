# 分布式基础

说到分布式，大家可能会听过许多专有名词，比如ACID，CAP，FLP之类的。包括我们说到区块链，大家一定听说过不可能三角，在这里，就来介绍一下一些分布式的基础名词的概念。

我们之所以需要将一个单机系统扩展到分布式系统，主要原因有：

1. 对性能的要求超过单机系统所能提供的极限
2. 对 Availability 的要求超过单机系统所能提供的极限

对于前者，我们可以使用 Shard 的方式将负载分布到多个单机系统中。对于后者，我们在设计时必须考虑 CAP 理论的约束。

## 分布式系统

**分布式系统**是由多个不同的服务节点组成，节点与节点之间通过消息传递进行通信和协调。根据消息传递的不同，分布式系统的运行模型可以分为**异步模型系统**和**同步模型系统**。

### 同步与异步

同步和异步关注的都是**消息通信机制**

#### 同步

同步是指系统中的各个节点的时钟误差存在上限；**并且消息传递必须在一定时间内完成**，否则认为失败；同时各个节点完成处理消息的时间是一定的。同步在发出一个调用时，在没有得到结果之前，该调用就不会返回。

#### 异步

异步是指系统中各个节点可能存在较大的时钟差异，同时消息传输时间是任意长的，各节点对消息进行处理的时间也可能是任意长的。也就是说，调用在发出之后，这个调用就直接返回了。

## 事务

数据库事务（简称：事务，Transaction）是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。

## ACID

1. **原子性**（Atomicity）：事务作为一个整体被执行，包含在其中的对数据库的操作**要么全部被执行，要么都不执行**。
2. **一致性**（Consistency）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足**完整性约束**。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到（这层语义也有说应该属于原子性）。
3. **隔离性**（Isolation）：多个事务并发执行时，**一个事务的执行不应影响其他事务的执行**，如同只有这一个操作在被数据库所执行一样。
4. **持久性**（Durability）：已被提交的事务对数据库的修改应该**永久**保存在数据库中。在事务结束时，此操作将不可逆转。

## CAP

C表示**一致性**（Consistency），指 Linearizability Consistency。

A表示**可用性**（Availability），指的是 100% 的 Read & Write Availability，非形式化的理解，在任意时刻对任意节点发起的（读或写）请求，无需等待与系统中其他节点通信的结果，即可进行“正确”响应。

P表示**分区容错性**（Partition Tolerance），表示某些节点crash系统是否还能正常工作。

其中一致性、可用性、分区容错性不能够同时满足，并且由于目前一般的网络条件不能认为是可靠的，因此构建在这样的网络上的系统必须认为 Partition 是可能发生的，进而在 CAP 理论中不能放弃 P 而选择 C 和 A只能够对其一致性或可用性进行取舍。由于 Partition 不是经常发生，在这样的情况下，C 和 A 是可以同时达到的。但是在 Partition 发生时，我们必须在 Linearizability Consistency 和 100% Availability 之间进行取舍。那么，

**如何判断是否正在发生 Network Partition？**

实践中我们通常采用消息超时的机制进行判断，即如果两个节点之间的通信（即便经过一些重试）超时，则认为此时正在发生 Network Partition。使用这种方法进行判断，我们会发现 Latency 和 Availability 是一回事。**Latency 低的时候**，节点之间可以正常通信，从而提供 Linearizability Consistency。**Latency 高的时候**，我们认为发生了 Network Partition，或者等待 Latency 降低到足以在 Threshold 内进行通信（Network Partition 解除），**即放弃 100% Availability 但是保证 Linearizability Consistency**，或者放弃节点间进行通信直接进行响应，**即放弃保证 Linearizability Consistency 但是提供 100% Availability**。

目前越来越多的系统即使在 P 没有发生时，也不提供 Linearizability Consistency，其这样做是为了**提供更高的性能保证**。

进一步考虑，我们之所以需要在 C 和 A 之间进行取舍，或者是在 C 和 L（Latency） 之间进行取舍，其根本原因在于节点之间需要进行 **同步通信** 才能够保证 C。极端情况下，我们可以使得整个系统**无需进行同步通信**，来达到极致的 A 和 L。此时考虑一个写请求，在写入一个节点并收到成功确认后，如果该节点在和其他节点进行 **异步通信** 之前就发生了永久性故障，则这一写请求写入的内容将永久性的丢失。这说明 Consistency 和 Durability 在某种程度上是类似的。

从一个更大的角度来看，在一个不可靠的分布式系统中，我们需要在 Safety 性质和 Liveness 性质之间进行取舍 。例如，Consistency 是一种 Safety 性质，而 Availability 是一种 Liveness 性质。又例如，FLP 问题告诉我们在 Consensus 问题中如果有任意节点不可靠，则无法在保证 Safety 性质的同时保证 Liveness 性质。

事实上，Availability 是服务的一个观测结果（Metric）而非系统的一个属性，而 Consistency 和 Partition 是系统模型，这两者并不能统一起来，**CAP 理论中对于 Availability 的定义是不严格的**。我们可以这样认为，Availability 和 Consistency 在 CAP 理论中并不是一个非 0 即 1 的离散变量，而是从 0% 至 100% 连续变化的变量。

## FLP

在网络可靠，但允许节点失效（即便只有一个）的最小化异步模型系统中，不存在一个可以解决一致性问题的确定性共识算法 