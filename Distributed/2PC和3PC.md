# 2PC和3PC

## 2PC:

二阶段提交协议，即将事物的提交过程分为两个阶段来进行处理：**准备阶段**和**提交阶段**。**事务的发起者称为协调者(coordinator)，事务的执行者称为参与者(participant)**

### 过程简介

#### 阶段1：准备阶段

1. 协调者向所有参与者发送事务内容，询问是否可以提交事务，并等待所有参与者答复。
2. 各参与者执行事务操作，将Undo和Redo信息记入事务日志中（但不提交事务）。
3. 如参与者执行成功，给协调者反馈YES，即可以提交；如执行失败，给协调者反馈NO，即不可提交。  

#### 阶段2：提交阶段

此阶段分两种情况：所有参与者均反馈YES、或任何一个参与者反馈NO。 **所有参与者均反馈YES时，即提交事务**; **任何一个参与者反馈NO时，即中断事务**。  

* **提交事务：（所有参与者均反馈YES）**

1. 协调者向所有参与者发出正式提交事务的请求（即Commit请求）。
2. 参与者执行Commit请求，并释放整个事务期间占用的资源。
3. 各参与者向协调者反馈Ack完成的消息。
4. 协调者收到所有参与者反馈的Ack消息后，即完成事务提交。

![准备并提交事务](./pics/Commit.png)

* **中断事务：（任何一个参与者反馈NO）**   

1. 协调者向所有参与者发出回滚请求（即Rollback请求）。
2. 参与者使用阶段1中的Undo信息执行回滚操作，并释放整个事务期间占用的资源。
3. 各参与者向协调者反馈Ack完成的消息。
4. 协调者收到所有参与者反馈的Ack消息后，即完成事务中断。

![准备并中断事务](./pics/Rollback.png)

### 2PC的缺陷

1. **同步阻塞**：最大的问题即同步阻塞，即：所有参与事务的逻辑均处于阻塞状态。

   执行过程中，所有参与节点都是事务阻塞型的，当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。即，从投票阶段到提交阶段完成这段时间，资源是被锁住的。

2. **单点**：协调者存在单点问题，如果协调者出现故障，参与者将一直处于锁定状态。

   尤其是在第二阶段，协调者发生故障时，所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作。

3. **脑裂**：在阶段2中，如果只有部分参与者接收并执行了Commit请求，会导致节点数据不一致。